version: "3"

vars:
  TERRAFORM_CONTAINER_NAME: terraform
  LINTER_CONTAINER_NAME: tflint
  SOPS_ENCRYPT_FILE: secret.enc.yaml
  AGE_KEY_FILE: /age/keys.txt

tasks:
  sethooks:
    cmds:
      - pre-commit install

  unsethooks:
    cmds:
      - pre-commit uninstall

  install:
    deps: [sethooks]
    cmds:
      - docker compose up -d --build
      - task init

  up:
    cmds:
      - docker compose up -d

  down:
    cmds:
      - docker compose down

  destroy:
    deps: [unsethooks]
    cmds:
      - docker compose down --rmi all --volumes --remove-orphans

  init:
    cmds:
      - docker compose exec -T {{.TERRAFORM_CONTAINER_NAME}} terraform init {{ .CLI_ARGS }}
      - docker compose exec -T {{.LINTER_CONTAINER_NAME}} tflint --init

  lint:
    cmds:
      - docker compose exec -T {{.TERRAFORM_CONTAINER_NAME}} terraform fmt
      - docker compose exec -T {{.TERRAFORM_CONTAINER_NAME}} terraform validate
      - docker compose exec -T {{.LINTER_CONTAINER_NAME}} tflint

  plan:
    deps: [lint]
    cmds:
      - docker compose exec -T {{.TERRAFORM_CONTAINER_NAME}} terraform plan {{ .CLI_ARGS }}

  apply:
    deps: [lint]
    cmds:
      - docker compose exec -T {{.TERRAFORM_CONTAINER_NAME}} terraform apply

  tf-destroy:
    deps: [lint]
    cmds:
      - docker compose exec -T {{.TERRAFORM_CONTAINER_NAME}} terraform destroy

  sh:
    cmds:
      - docker compose exec {{.TERRAFORM_CONTAINER_NAME}} ash

  log:
    cmds:
      - docker compose logs

  edit-secret:
    aliases: [es]
    cmds:
      - export SOPS_AGE_KEY_FILE=$(pwd)/{{.AGE_KEY_FILE}} && EDITOR="code --wait" sops  {{.SOPS_ENCRYPT_FILE}}
